<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_saleorder_document_inherit_numbering" inherit_id="sale.report_saleorder_document" priority="20">
    <!-- 1. Insérer la colonne "N°" avant "Description" dans l'en-tête -->
    <xpath expr="//thead/tr/th[@name='th_description']" position="before">
      <th class="text-end" style="width:3%;">N°</th>

      <!-- Ajout colonne Référence avant Description -->
      <th class="text-start" style="width: 25mm;">Code</th>
    </xpath>

    <!-- 2. Remplacement du tbody pour ajouter les colonnes numéro et référence dans chaque ligne -->
    <xpath expr="//tbody[@class='sale_tbody']" position="replace">
      <tbody class="sale_tbody">
        <t t-set="current_subtotal" t-value="0"/>
        <t t-set="current_section" t-value="None"/>
        <t t-foreach="lines_to_report" t-as="line" t-index="line_index">

          <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>

          <tr
            t-att-class="'fw-bold o_line_section' if (line.display_type == 'line_section' or line.product_type == 'combo') else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''"
          >
            <!-- Nouvelle colonne N° -->
            <td class="text-end" style="width:3%;"><t t-esc="line_index + 1"/></td>

            <!-- Nouvelle colonne Référence -->
            <td class="text-start" style="width: 25mm;">
              <span t-esc="line.product_id and line.product_id.default_code or ''"/>
            </td>

            <t t-if="not line.display_type and line.product_type != 'combo'">
              <td name="td_name"><span t-field="line.name"/></td>
              <td class="text-end">
                <span t-field="line.product_uom_qty"/>
                <span t-field="line.product_uom"/><!--Pour unité de la quantité, en fonction de la version mettre id pour les versions plus recente-->
                <span> </span>
              </td>
              

              <td name="td_priceunit" class="text-end text-nowrap">
                <span t-field="line.price_unit"/>
              </td>

              <td t-if="display_discount" class="text-end">
                <span t-field="line.discount"/>
              </td>
<!--Pour les taxes, certains orderline requiert un (s) aux id en cas d'erreur toujours verifier dans les parametres/Technique/sale.order.line et tu verifie le champs tax_id/tax_ids-->
              
              <t t-if="line.tax_id">
                  <td name="td_taxes" class="text-end text-nowrap">
                      <span t-field="line.tax_id"/>
                  </td>
              </t>
              <t t-else="">
                  <td name="td_taxes" class="text-end text-muted"> </td>
              </t>


              <td t-if="not line.is_downpayment" name="td_subtotal" class="text-end o_price_total">
                <span t-field="line.price_subtotal"/>
              </td>
            </t>

            <t t-elif="line.display_type == 'line_section' or line.product_type == 'combo'">
              <td name="td_section_line" colspan="99"><span t-field="line.name"/></td>
              <t t-set="current_section" t-value="line"/>
              <t t-set="current_subtotal" t-value="0"/>
            </t>

            <t t-elif="line.display_type == 'line_note'">
              <td name="td_note_line" colspan="99"><span t-field="line.name"/></td>
            </t>
          </tr>

          <t
            t-if="current_section and (
              line_index + 1 == len(lines_to_report)
              or lines_to_report[line_index+1].display_type == 'line_section'
              or lines_to_report[line_index+1].product_type == 'combo'
              or (
                line.combo_item_id and not lines_to_report[line_index+1].combo_item_id
              )
            ) and not line.is_downpayment"
          >
            <t t-set="current_section" t-value="None"/>
            <tr class="is-subtotal text-end">
              <td name="td_section_subtotal" colspan="99">
                <strong class="mr16">Subtotal</strong>
                <span
                  t-out="current_subtotal"
                  t-options='{"widget": "monetary", "display_currency": doc.currency_id}'
                />
              </td>
            </tr>
          </t>

        </t>
      </tbody>
    </xpath>

  </template>
</odoo>
