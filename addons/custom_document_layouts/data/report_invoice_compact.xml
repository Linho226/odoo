<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Vue héritée pour compacter les lignes de facture -->
  <template id="report_invoice_compact" inherit_id="account.report_invoice_document">

    <!-- 1️⃣  Compter le nb de lignes (juste avant d’en avoir besoin) -->
    <xpath expr="//t[@t-set='display_discount']" position="before">
      <!-- len(o.invoice_line_ids) ⇒ nombre de lignes produits  -->
      <t t-set="line_count" t-value="len(o.invoice_line_ids)"/>
      <!-- Seuil : 10 lignes ; ajuste à ta convenance -->
      <t t-set="need_compact" t-value="line_count >= 1000"/>
    </xpath>

    <!-- 2️⃣  Injecter le CSS juste avant le tableau -->
    <xpath expr="//table[@name='invoice_line_table']" position="before">
      <t t-if="report_type == 'pdf' and need_compact">
        <style>
          /* Réduction padding + police pour le tableau compact */
          .o_main_table.compact th,
          .o_main_table.compact td {
            padding: 2px 4px !important;
            font-size: 11px !important;                      <!-- ou 11px si tu veux un peu plus grand -->
            line-height: 1.1 !important;
          }
        </style>
      </t>
    </xpath>

    <!-- 3️⃣  Ajouter dynamiquement la classe `compact` au tableau -->
    <xpath expr="//table[@name='invoice_line_table']" position="attributes">
      <!-- On reconstruit l’attribut class pour y greffer 'compact' si besoin -->
      <attribute name="t-attf-class">
        o_has_total_table table o_main_table table-borderless {{ 'compact' if need_compact else '' }}
      </attribute>
    </xpath>

  </template>
</odoo>
